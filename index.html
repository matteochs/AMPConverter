<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>AMP Extractor con parametri URL + filtro</title>
  <style>
    body { font-family: sans-serif; margin: 2em; max-width: 700px; }
    code { background: #eee; padding: 0.2em 0.4em; border-radius: 3px; }
    #results { margin-top: 1em; white-space: pre-wrap; background: #f2f2f2; padding: 1em; }
  </style>
</head>
<body>
  <h1>Link AMP generati</h1>
  <p>Estrazione automatica da <code>?url=...</code> con filtro opzionale <code>&filter=...</code></p>
  <div id="results">In corso...</div>

  <script>
    function getQueryParam(param) {
      const params = new URLSearchParams(window.location.search);
      return params.get(param);
    }

    async function run() {
      const targetUrl = getQueryParam("url");
      const filtersRaw = getQueryParam("filter");
      const filters = filtersRaw ? filtersRaw.toLowerCase().split(",") : [];
      const output = document.getElementById("results");

      if (!targetUrl) {
        output.textContent = "Errore: manca il parametro ?url=...";
        return;
      }

      const proxy = "https://corsproxy.io/?" + encodeURIComponent(targetUrl);

      try {
        const res = await fetch(proxy);
        const text = await res.text();

        const matches = [...text.matchAll(/https?:\\/\\/[\\w\\.-]+\\/[\\w\\./-]*?\\.s?html/g)];
        const links = matches.map(m => m[0]);

        const filtered = links.filter(link =>
          (link.includes("corriere.it") || link.includes("gazzetta.it")) &&
          (filters.length === 0 || filters.some(f => link.toLowerCase().includes(f)))
        );

        const ampLinks = filtered.map(link =>
          link.replace(/\\.s?html$/, "_amp.shtml")
        );

        output.textContent = ampLinks.length ? ampLinks.join("\\n") : "Nessun link AMP trovato.";
      } catch (e) {
        output.textContent = "Errore: " + e.message;
      }
    }

    run();
  </script>
</body>
</html>
